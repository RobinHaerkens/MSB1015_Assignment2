---
title: "MSB1015_Assignment_2"
output: html_document
---
#loading in all the required packages
#Required packages are WikidataQueryServiceR to obtain the data from wikidata
#rJAVA and rcdk are required to predict the pb based on the smiles
#pls to predict bp aswel
```{r setup, include=FALSE}
if(!"RCy3" %in% installed.packages()){
  install.packages("WikidataQueryServiceR")
  install.packages("rJava")
  install.packages ("rcdk") 
  install.packages("pls")
}
  library(WikidataQueryServiceR)
  library(rJava)
  library(rcdk)
  library(pls)
```

#loading in the data using SPARQL
#requesting boiling point of all alkanes with units and SMILES data
```{r}
sparql_query <- 'SELECT DISTINCT ?comp ?compLabel ?bp ?bpUnitLabel ?SMILE WHERE {
    ?comp wdt:P31/wdt:P279* wd:Q41581 ;
  p:P2102 [
    ps:P2102 ?bp ;
    psv:P2102/wikibase:quantityUnit  ?bpUnit
    ] ;
  wdt:P233 ?SMILE .
  SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }
}'
results = query_wikidata(sparql_query)
```

#data preprocessing and control, remove brackets from smile string for data control
```{r}
#save the actual SMILES for later use
results_SMILES <- results[,5]
#remove "(" and ")" to get a line of just C's
pattern<- "\\("
replacement <- ""
results[,5] <- gsub(pattern, replacement, results[,5])
pattern<- "\\)"
results[,5] <- gsub(pattern, replacement, results[,5])
#plot the amount of C's against bp to see releation and look for outlayers
plot(results[order(nchar(results[,5])),3], xlab="alkane length", ylab="bp")
```
#it looks from the plot that the units are not all equal
#changing all of the units kelvin(T(C)+273.15, T(°F) + 459.67) × 5/9)
```{r}
#change Celsius to Kelvin
for(i in 1:nrow(results)){
  if (results[i,4] == "degree Celsius"){
  results[i,3] <- results[i,3]+273.15
  results[i,4] <- "kelvin"
}
}
#Change Fahrenheit to Kelvin
for(i in 1:nrow(results)){
  if (results[i,4] == "degree Fahrenheit"){
  results[i,3] <- ((results[i,3]+ 459.67)*5/9)
  results[i,4] <- "kelvin"
}
}
```
#data  control after changing temperatures to celsius
```{r}
#plot again with all units converted to kelvin
plot(results[order(nchar(results[,5])),3], xlab="alkane length", ylab="bp")

```
#get all the molecular information from the rcdk package for the alkanes based on SMILES
```{r}
#reassign the orignal SMILES to the results
results[,5] <- results_SMILES
#parse all the alkane smiles through the rcdk package to obtain all availlable information
results.rcdk <- parse.smiles(results[,5])

#select descriptive categories
dc <- get.desc.categories()
#select names of discriptive topological caterogies)
dn <- get.desc.names(dc[3])

allDescs <- eval.desc(results.rcdk, dn)
```

#creating data object to use for plsr model
```{r}
#create a df with bp and all features to use for plsr model
results.plsr <- cbind(results$bp, allDescs)
colnames(results.plsr)[1] <- 'bp'

#removing NAs and NANs
results.plsr <- results.plsr[ , -which(names(results.plsr) %in% c("VABC","geomShape"))]
```

#Splitting data into a test and training set
```{r}
## 80% of the dataset size
smp_size <- floor(.80 * nrow(results.plsr))

## set the seed to get the same test and training sets when rerunning the code
set.seed(1)
train_ind <- sample(seq_len(nrow(results.plsr)), size = smp_size)

train <- results.plsr[train_ind, ]
test <- results.plsr[-train_ind, ]
```

#Making plsr model based on the training data set
```{r}

bp.plsr <- plsr(bp ~. , data=train, validation = "LOO", ncomp=4)

```
#testing the models accuracy on the test data set
```{r}
bp_index <- which(colnames(test) == "bp")
Prediction <- RMSEP(bp.plsr, newdata=test)
#compare predicted bp's to actual bp's and look at the RMSEP
Prediction
#RMSEP is 54.87 at time of running
```